{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/Users/neville/Documents/Github/elrond-delegation/node_modules/@babel/runtime/helpers/regeneratorRuntime.js\").default;\nvar _classCallCheck = require(\"/Users/neville/Documents/Github/elrond-delegation/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\nvar _createClass = require(\"/Users/neville/Documents/Github/elrond-delegation/node_modules/@babel/runtime/helpers/createClass.js\").default;\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ExtensionProvider = void 0;\nvar primitives_1 = require(\"./primitives\");\nvar operation_1 = require(\"./operation\");\nvar errors_1 = require(\"./errors\");\nvar ExtensionProvider = /*#__PURE__*/function () {\n  function ExtensionProvider() {\n    _classCallCheck(this, ExtensionProvider);\n    this.account = {\n      address: \"\"\n    };\n    this.initialized = false;\n    if (ExtensionProvider._instance) {\n      throw new Error(\"Error: Instantiation failed: Use ExtensionProvider.getInstance() instead of new.\");\n    }\n    ExtensionProvider._instance = this;\n  }\n  _createClass(ExtensionProvider, [{\n    key: \"setAddress\",\n    value: function setAddress(address) {\n      this.account.address = address;\n      return ExtensionProvider._instance;\n    }\n  }, {\n    key: \"init\",\n    value: function init() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              if (window && window.elrondWallet) {\n                this.initialized = true;\n              }\n              return _context.abrupt(\"return\", this.initialized);\n            case 2:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee, this);\n      }));\n    }\n  }, {\n    key: \"login\",\n    value: function login() {\n      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n        var token, data;\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              if (this.initialized) {\n                _context2.next = 2;\n                break;\n              }\n              throw new Error(\"Extension provider is not initialised, call init() first\");\n            case 2:\n              token = options.token;\n              data = token ? token : \"\";\n              _context2.next = 6;\n              return this.startBgrMsgChannel(operation_1.Operation.Connect, data);\n            case 6:\n              return _context2.abrupt(\"return\", this.account.address);\n            case 7:\n            case \"end\":\n              return _context2.stop();\n          }\n        }, _callee2, this);\n      }));\n    }\n  }, {\n    key: \"logout\",\n    value: function logout() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee3() {\n        return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n          while (1) switch (_context3.prev = _context3.next) {\n            case 0:\n              if (this.initialized) {\n                _context3.next = 2;\n                break;\n              }\n              throw new Error(\"Extension provider is not initialised, call init() first\");\n            case 2:\n              _context3.prev = 2;\n              _context3.next = 5;\n              return this.startBgrMsgChannel(operation_1.Operation.Logout, this.account.address);\n            case 5:\n              this.disconnect();\n              _context3.next = 11;\n              break;\n            case 8:\n              _context3.prev = 8;\n              _context3.t0 = _context3[\"catch\"](2);\n              console.warn(\"Extension origin url is already cleared!\", _context3.t0);\n            case 11:\n              return _context3.abrupt(\"return\", true);\n            case 12:\n            case \"end\":\n              return _context3.stop();\n          }\n        }, _callee3, this, [[2, 8]]);\n      }));\n    }\n  }, {\n    key: \"disconnect\",\n    value: function disconnect() {\n      this.account = {\n        address: \"\"\n      };\n    }\n  }, {\n    key: \"getAddress\",\n    value: function getAddress() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee4() {\n        return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n          while (1) switch (_context4.prev = _context4.next) {\n            case 0:\n              if (this.initialized) {\n                _context4.next = 2;\n                break;\n              }\n              throw new Error(\"Extension provider is not initialised, call init() first\");\n            case 2:\n              return _context4.abrupt(\"return\", this.account ? this.account.address : \"\");\n            case 3:\n            case \"end\":\n              return _context4.stop();\n          }\n        }, _callee4, this);\n      }));\n    }\n  }, {\n    key: \"isInitialized\",\n    value: function isInitialized() {\n      return this.initialized;\n    }\n    // TODO: In V3, this will not be an async function anymore.\n  }, {\n    key: \"isConnected\",\n    value: function isConnected() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee5() {\n        return _regeneratorRuntime().wrap(function _callee5$(_context5) {\n          while (1) switch (_context5.prev = _context5.next) {\n            case 0:\n              return _context5.abrupt(\"return\", Boolean(this.account.address));\n            case 1:\n            case \"end\":\n              return _context5.stop();\n          }\n        }, _callee5, this);\n      }));\n    }\n  }, {\n    key: \"signTransaction\",\n    value: function signTransaction(transaction) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee6() {\n        var signedTransactions;\n        return _regeneratorRuntime().wrap(function _callee6$(_context6) {\n          while (1) switch (_context6.prev = _context6.next) {\n            case 0:\n              this.ensureConnected();\n              _context6.next = 3;\n              return this.signTransactions([transaction]);\n            case 3:\n              signedTransactions = _context6.sent;\n              if (!(signedTransactions.length != 1)) {\n                _context6.next = 6;\n                break;\n              }\n              throw new errors_1.ErrCannotSignSingleTransaction();\n            case 6:\n              return _context6.abrupt(\"return\", signedTransactions[0]);\n            case 7:\n            case \"end\":\n              return _context6.stop();\n          }\n        }, _callee6, this);\n      }));\n    }\n  }, {\n    key: \"ensureConnected\",\n    value: function ensureConnected() {\n      if (!this.account.address) {\n        throw new errors_1.ErrAccountNotConnected();\n      }\n    }\n  }, {\n    key: \"signTransactions\",\n    value: function signTransactions(transactions) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee7() {\n        var extensionResponse, i, transaction, plainSignedTransaction;\n        return _regeneratorRuntime().wrap(function _callee7$(_context7) {\n          while (1) switch (_context7.prev = _context7.next) {\n            case 0:\n              this.ensureConnected();\n              _context7.next = 3;\n              return this.startBgrMsgChannel(operation_1.Operation.SignTransactions, {\n                from: this.account.address,\n                transactions: transactions.map(function (transaction) {\n                  return transaction.toPlainObject();\n                })\n              });\n            case 3:\n              extensionResponse = _context7.sent;\n              _context7.prev = 4;\n              for (i = 0; i < transactions.length; i++) {\n                transaction = transactions[i];\n                plainSignedTransaction = extensionResponse[i];\n                transaction.applySignature(new primitives_1.Signature(plainSignedTransaction.signature), new primitives_1.Address(this.account.address));\n              }\n              return _context7.abrupt(\"return\", transactions);\n            case 9:\n              _context7.prev = 9;\n              _context7.t0 = _context7[\"catch\"](4);\n              throw new Error(\"Transaction canceled: \".concat(_context7.t0.message, \".\"));\n            case 12:\n            case \"end\":\n              return _context7.stop();\n          }\n        }, _callee7, this, [[4, 9]]);\n      }));\n    }\n  }, {\n    key: \"signMessage\",\n    value: function signMessage(message) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee8() {\n        var data, extensionResponse;\n        return _regeneratorRuntime().wrap(function _callee8$(_context8) {\n          while (1) switch (_context8.prev = _context8.next) {\n            case 0:\n              this.ensureConnected();\n              data = {\n                account: this.account.address,\n                message: message.message.toString()\n              };\n              _context8.next = 4;\n              return this.startBgrMsgChannel(operation_1.Operation.SignMessage, data);\n            case 4:\n              extensionResponse = _context8.sent;\n              message.applySignature(new primitives_1.Signature(extensionResponse.signature), new primitives_1.Address(this.account.address));\n              return _context8.abrupt(\"return\", message);\n            case 7:\n            case \"end\":\n              return _context8.stop();\n          }\n        }, _callee8, this);\n      }));\n    }\n  }, {\n    key: \"cancelAction\",\n    value: function cancelAction() {\n      return this.startBgrMsgChannel(operation_1.Operation.CancelAction, {});\n    }\n  }, {\n    key: \"startBgrMsgChannel\",\n    value: function startBgrMsgChannel(operation, connectData) {\n      var _this = this;\n      return new Promise(function (resolve) {\n        window.postMessage({\n          target: \"erdw-inpage\",\n          type: operation,\n          data: connectData\n        }, window.origin);\n        var eventHandler = function eventHandler(event) {\n          if (event.isTrusted && event.data.target === \"erdw-contentScript\") {\n            if (event.data.type === \"connectResponse\") {\n              if (event.data.data && Boolean(event.data.data.address)) {\n                _this.account = event.data.data;\n              }\n              window.removeEventListener(\"message\", eventHandler);\n              resolve(event.data.data);\n            } else {\n              window.removeEventListener(\"message\", eventHandler);\n              resolve(event.data.data);\n            }\n          }\n        };\n        window.addEventListener(\"message\", eventHandler, false);\n      });\n    }\n  }], [{\n    key: \"getInstance\",\n    value: function getInstance() {\n      return ExtensionProvider._instance;\n    }\n  }]);\n  return ExtensionProvider;\n}();\nexports.ExtensionProvider = ExtensionProvider;\nExtensionProvider._instance = new ExtensionProvider();","map":{"version":3,"sources":["../src/extensionProvider.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.ExtensionProvider = void 0;\nconst primitives_1 = require(\"./primitives\");\nconst operation_1 = require(\"./operation\");\nconst errors_1 = require(\"./errors\");\nclass ExtensionProvider {\n    constructor() {\n        this.account = { address: \"\" };\n        this.initialized = false;\n        if (ExtensionProvider._instance) {\n            throw new Error(\"Error: Instantiation failed: Use ExtensionProvider.getInstance() instead of new.\");\n        }\n        ExtensionProvider._instance = this;\n    }\n    static getInstance() {\n        return ExtensionProvider._instance;\n    }\n    setAddress(address) {\n        this.account.address = address;\n        return ExtensionProvider._instance;\n    }\n    init() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (window && window.elrondWallet) {\n                this.initialized = true;\n            }\n            return this.initialized;\n        });\n    }\n    login(options = {}) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.initialized) {\n                throw new Error(\"Extension provider is not initialised, call init() first\");\n            }\n            const { token } = options;\n            const data = token ? token : \"\";\n            yield this.startBgrMsgChannel(operation_1.Operation.Connect, data);\n            return this.account.address;\n        });\n    }\n    logout() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.initialized) {\n                throw new Error(\"Extension provider is not initialised, call init() first\");\n            }\n            try {\n                yield this.startBgrMsgChannel(operation_1.Operation.Logout, this.account.address);\n                this.disconnect();\n            }\n            catch (error) {\n                console.warn(\"Extension origin url is already cleared!\", error);\n            }\n            return true;\n        });\n    }\n    disconnect() {\n        this.account = { address: \"\" };\n    }\n    getAddress() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.initialized) {\n                throw new Error(\"Extension provider is not initialised, call init() first\");\n            }\n            return this.account ? this.account.address : \"\";\n        });\n    }\n    isInitialized() {\n        return this.initialized;\n    }\n    // TODO: In V3, this will not be an async function anymore.\n    isConnected() {\n        return __awaiter(this, void 0, void 0, function* () {\n            return Boolean(this.account.address);\n        });\n    }\n    signTransaction(transaction) {\n        return __awaiter(this, void 0, void 0, function* () {\n            this.ensureConnected();\n            const signedTransactions = yield this.signTransactions([transaction]);\n            if (signedTransactions.length != 1) {\n                throw new errors_1.ErrCannotSignSingleTransaction();\n            }\n            return signedTransactions[0];\n        });\n    }\n    ensureConnected() {\n        if (!this.account.address) {\n            throw new errors_1.ErrAccountNotConnected();\n        }\n    }\n    signTransactions(transactions) {\n        return __awaiter(this, void 0, void 0, function* () {\n            this.ensureConnected();\n            const extensionResponse = yield this.startBgrMsgChannel(operation_1.Operation.SignTransactions, {\n                from: this.account.address,\n                transactions: transactions.map(transaction => transaction.toPlainObject()),\n            });\n            try {\n                for (let i = 0; i < transactions.length; i++) {\n                    const transaction = transactions[i];\n                    const plainSignedTransaction = extensionResponse[i];\n                    transaction.applySignature(new primitives_1.Signature(plainSignedTransaction.signature), new primitives_1.Address(this.account.address));\n                }\n                return transactions;\n            }\n            catch (error) {\n                throw new Error(`Transaction canceled: ${error.message}.`);\n            }\n        });\n    }\n    signMessage(message) {\n        return __awaiter(this, void 0, void 0, function* () {\n            this.ensureConnected();\n            const data = {\n                account: this.account.address,\n                message: message.message.toString()\n            };\n            const extensionResponse = yield this.startBgrMsgChannel(operation_1.Operation.SignMessage, data);\n            message.applySignature(new primitives_1.Signature(extensionResponse.signature), new primitives_1.Address(this.account.address));\n            return message;\n        });\n    }\n    cancelAction() {\n        return this.startBgrMsgChannel(operation_1.Operation.CancelAction, {});\n    }\n    startBgrMsgChannel(operation, connectData) {\n        return new Promise((resolve) => {\n            window.postMessage({\n                target: \"erdw-inpage\",\n                type: operation,\n                data: connectData,\n            }, window.origin);\n            const eventHandler = (event) => {\n                if (event.isTrusted && event.data.target === \"erdw-contentScript\") {\n                    if (event.data.type === \"connectResponse\") {\n                        if (event.data.data && Boolean(event.data.data.address)) {\n                            this.account = event.data.data;\n                        }\n                        window.removeEventListener(\"message\", eventHandler);\n                        resolve(event.data.data);\n                    }\n                    else {\n                        window.removeEventListener(\"message\", eventHandler);\n                        resolve(event.data.data);\n                    }\n                }\n            };\n            window.addEventListener(\"message\", eventHandler, false);\n        });\n    }\n}\nexports.ExtensionProvider = ExtensionProvider;\nExtensionProvider._instance = new ExtensionProvider();\n//# sourceMappingURL=extensionProvider.js.map"]},"metadata":{},"sourceType":"script"}